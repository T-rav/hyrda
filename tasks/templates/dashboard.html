{% extends "base.html" %}

{% block title %}Dashboard - InsightMesh Tasks{% endblock %}

{% block content %}
<div class="glass-card mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <h2 class="mb-0"><i data-lucide="layout-dashboard" class="icon text-primary me-2"></i>Dashboard</h2>
        <div>
            <button id="auto-refresh-btn" class="btn btn-outline-primary me-2" onclick="toggleAutoRefresh()">
                <i data-lucide="play" class="icon-sm me-1"></i>Auto-refresh
            </button>
            <button class="btn btn-outline-secondary" onclick="refreshData()">
                <i data-lucide="refresh-cw" class="icon-sm me-1"></i>Refresh
            </button>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="glass-card stat-card stat-card-primary">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="stat-number" id="total-tasks">-</h3>
                    <p class="stat-label">Total Tasks</p>
                </div>
                <div class="stat-icon">
                    <i data-lucide="list-checks" class="icon-lg"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="glass-card stat-card stat-card-success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="stat-number" id="running-tasks">-</h3>
                    <p class="stat-label">ACTIVE Tasks</p>
                </div>
                <div class="stat-icon">
                    <i data-lucide="play-circle" class="icon-lg"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="glass-card stat-card stat-card-warning">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="stat-number" id="paused-tasks">-</h3>
                    <p class="stat-label">Paused Tasks</p>
                </div>
                <div class="stat-icon">
                    <i data-lucide="pause-circle" class="icon-lg"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="glass-card stat-card stat-card-info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="stat-number" id="next-run">-</h3>
                    <p class="stat-label">Next Run</p>
                </div>
                <div class="stat-icon">
                    <i data-lucide="clock" class="icon-lg"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scheduler Status -->
<div class="glass-card mb-4">
    <h3 class="mb-3"><i data-lucide="server" class="icon me-2"></i>Scheduler Status</h3>
    <div class="row" id="scheduler-info">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- Recent Runs -->
<div class="glass-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">
            <i data-lucide="history" class="icon me-2"></i>Recent Runs
        </h3>
        <a href="#" onclick="showAllRuns()" class="btn btn-sm btn-outline-primary">
            View All <i data-lucide="arrow-right" class="icon-sm ms-1"></i>
        </a>
    </div>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Started</th>
                    <th>Status</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody id="recent-tasks-table">
                <tr>
                    <td colspan="4" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls (hidden by default) -->
    <div id="pagination-controls" class="d-flex justify-content-between align-items-center mt-3" style="display: none;">
        <div class="text-muted">
            Showing <span id="showing-start">1</span>-<span id="showing-end">5</span> of <span id="total-records">0</span> runs
        </div>
        <nav aria-label="Task runs pagination">
            <ul class="pagination pagination-sm mb-0" id="pagination-list">
                <!-- Pagination items will be inserted here -->
            </ul>
        </nav>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let schedulerData = {};
    let tasksData = [];
    let taskRunsData = [];
    let currentPage = 1;
    const recordsPerPage = 20;

    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        refreshData();
    });

    async function refreshData() {
        try {
            await Promise.all([
                loadSchedulerInfo(),
                loadTasks(),
                loadTaskRuns()
            ]);
            updateDashboard();
        } catch (error) {
            console.error('Error refreshing data:', error);
            showToast('Error refreshing data: ' + error.message, 'danger');
        }
    }

    async function loadSchedulerInfo() {
        try {
            schedulerData = await apiCall('/api/scheduler/info');
        } catch (error) {
            console.error('Error loading scheduler info:', error);
            schedulerData = { running: false, tasks_count: 0 };
        }
    }

    async function loadTasks() {
        try {
            const response = await apiCall('/api/jobs');
            tasksData = response.jobs || [];
        } catch (error) {
            console.error('Error loading tasks:', error);
            tasksData = [];
        }
    }

    async function loadTaskRuns() {
        try {
            const response = await apiCall('/api/task-runs');
            taskRunsData = response.task_runs || [];
        } catch (error) {
            console.error('Error loading task runs:', error);
            taskRunsData = [];
        }
    }

    function updateDashboard() {
        updateSchedulerInfo();
        updateStatistics();
        updateRecentTasksTable();
    }

    function updateSchedulerInfo() {
        const container = document.getElementById('scheduler-info');

        // Calculate run statistics
        const totalRuns = taskRunsData.length;
        const successfulRuns = taskRunsData.filter(run => run.status === 'success').length;
        const failedRuns = taskRunsData.filter(run => run.status === 'failed').length;
        const runningRuns = taskRunsData.filter(run => run.status === 'running').length;
        const successRate = totalRuns > 0 ? Math.round((successfulRuns / totalRuns) * 100) : 0;

        container.innerHTML = `
            <div class="col-md-6">
                <strong>Total Runs:</strong>
                <span class="badge bg-info ms-2">${totalRuns}</span>
            </div>
            <div class="col-md-6">
                <strong>Success Rate:</strong>
                <span class="badge ${successRate >= 90 ? 'bg-success' : successRate >= 70 ? 'bg-warning' : 'bg-danger'} ms-2">
                    ${successRate}% (${successfulRuns}/${totalRuns})
                </span>
            </div>
        `;
    }

    function updateStatistics() {
        const totalTasks = tasksData.length;
        const runningTasks = tasksData.filter(job => job.next_run_time).length;
        const pausedTasks = tasksData.filter(job => !job.next_run_time).length;

        // Find next run time
        const nextRuns = tasksData
            .filter(job => job.next_run_time)
            .map(job => new Date(job.next_run_time))
            .sort((a, b) => a - b);

        const nextRun = nextRuns.length > 0 ? nextRuns[0] : null;

        document.getElementById('total-tasks').textContent = totalTasks;
        document.getElementById('running-tasks').textContent = runningTasks;
        document.getElementById('paused-tasks').textContent = pausedTasks;

        if (nextRun) {
            const now = new Date();
            const diff = nextRun - now;
            const minutes = Math.floor(diff / 60000);
            document.getElementById('next-run').textContent = minutes > 0 ? `${minutes}m` : 'Now';
        } else {
            document.getElementById('next-run').textContent = 'None';
        }
    }

    function updateRecentTasksTable() {
        const tbody = document.getElementById('recent-tasks-table');
        const paginationControls = document.getElementById('pagination-controls');

        if (taskRunsData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No recent runs</td></tr>';
            paginationControls.style.display = 'none';
            return;
        }

        const showAll = window.showAllRunsMode || false;
        let recentRuns;

        if (showAll) {
            // Show paginated results
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            recentRuns = taskRunsData.slice(startIndex, endIndex);

            // Show pagination controls only if we have more than one page
            const totalPages = Math.ceil(taskRunsData.length / recordsPerPage);
            if (totalPages > 1) {
                paginationControls.style.display = 'flex';
                paginationControls.style.visibility = 'visible';
                updatePaginationControls();
            } else {
                paginationControls.style.display = 'none';
                paginationControls.style.visibility = 'hidden';
            }
        } else {
            // Show just recent 5
            recentRuns = taskRunsData.slice(0, 5);
            paginationControls.style.display = 'none';
            paginationControls.style.visibility = 'hidden';
        }

        tbody.innerHTML = recentRuns.map(run => {
            const statusBadge = {
                'running': 'bg-primary',
                'success': 'bg-success',
                'failed': 'bg-danger',
                'cancelled': 'bg-secondary'
            }[run.status] || 'bg-secondary';

            const statusIcon = {
                'running': 'fa-spinner fa-spin',
                'success': 'fa-check',
                'failed': 'fa-times',
                'cancelled': 'fa-ban'
            }[run.status] || 'fa-question';

            const duration = run.duration_seconds ?
                `${run.duration_seconds.toFixed(1)}s` :
                (run.status === 'running' ? 'Running...' : 'N/A');

            return `
            <tr>
                <td>
                    <strong>${run.job_name || 'Unknown Job'}</strong>
                    ${run.triggered_by === 'manual' ? '<span class="badge bg-info ms-2">Manual</span>' : ''}
                </td>
                <td>${run.started_at ? formatDate(run.started_at) : 'N/A'}</td>
                <td>
                    <span class="badge ${statusBadge}">
                        <i class="fas ${statusIcon} me-1"></i>
                        ${run.status.charAt(0).toUpperCase() + run.status.slice(1)}
                    </span>
                </td>
                <td>
                    <small class="text-muted">
                        ${duration}
                        ${run.records_processed ? ` â€¢ ${run.records_processed} records` : ''}
                    </small>
                </td>
            </tr>
        `;
        }).join('');
    }

    // Show all runs function
    function showAllRuns() {
        window.showAllRunsMode = !window.showAllRunsMode;
        const button = document.querySelector('a[onclick="showAllRuns()"]');

        if (window.showAllRunsMode) {
            button.innerHTML = 'Show Recent <i data-lucide="arrow-up" class="icon-sm ms-1"></i>';
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-primary');
            currentPage = 1; // Reset to first page when expanding
        } else {
            button.innerHTML = 'View All <i data-lucide="arrow-right" class="icon-sm ms-1"></i>';
            button.classList.remove('btn-primary');
            button.classList.add('btn-outline-primary');
        }

        updateRecentTasksTable();
        // Re-initialize lucide icons for the new button content
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    // Pagination functions
    function updatePaginationControls() {
        const totalRecords = taskRunsData.length;
        const totalPages = Math.ceil(totalRecords / recordsPerPage);
        const startRecord = (currentPage - 1) * recordsPerPage + 1;
        const endRecord = Math.min(currentPage * recordsPerPage, totalRecords);

        // Update showing text
        document.getElementById('showing-start').textContent = startRecord;
        document.getElementById('showing-end').textContent = endRecord;
        document.getElementById('total-records').textContent = totalRecords;

        // Update pagination buttons
        const paginationList = document.getElementById('pagination-list');
        paginationList.innerHTML = '';

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
        paginationList.appendChild(prevLi);

        // Page numbers (show max 5 pages around current)
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) {
            const firstLi = document.createElement('li');
            firstLi.className = 'page-item';
            firstLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(1)">1</a>`;
            paginationList.appendChild(firstLi);

            if (startPage > 2) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                paginationList.appendChild(ellipsisLi);
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
            paginationList.appendChild(li);
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                paginationList.appendChild(ellipsisLi);
            }

            const lastLi = document.createElement('li');
            lastLi.className = 'page-item';
            lastLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a>`;
            paginationList.appendChild(lastLi);
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
        paginationList.appendChild(nextLi);
    }

    function changePage(page) {
        const totalPages = Math.ceil(taskRunsData.length / recordsPerPage);
        if (page < 1 || page > totalPages) return;

        currentPage = page;
        updateRecentTasksTable();
    }

    // Task action functions
    function viewTask(taskId) {
        window.location.href = `/tasks?task=${taskId}`;
    }

    async function pauseTask(taskId) {
        try {
            await apiCall(`/api/jobs/${taskId}/pause`, { method: 'POST' });
            showToast(`Task ${taskId} paused successfully`, 'success');
            refreshData();
        } catch (error) {
            showToast(`Error pausing task: ${error.message}`, 'danger');
        }
    }

    async function resumeTask(taskId) {
        try {
            await apiCall(`/api/jobs/${taskId}/resume`, { method: 'POST' });
            showToast(`Task ${taskId} resumed successfully`, 'success');
            refreshData();
        } catch (error) {
            showToast(`Error resuming task: ${error.message}`, 'danger');
        }
    }

    async function deleteTask(taskId) {
        if (!confirm(`Are you sure you want to delete task ${taskId}?`)) {
            return;
        }

        try {
            await apiCall(`/api/jobs/${taskId}`, { method: 'DELETE' });
            showToast(`Task ${taskId} deleted successfully`, 'success');
            refreshData();
        } catch (error) {
            showToast(`Error deleting task: ${error.message}`, 'danger');
        }
    }
</script>
{% endblock %}
