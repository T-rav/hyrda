import React from 'react'
import { theme } from '../theme'
import { useHydraFlow } from '../context/HydraFlowContext'
function TrendIndicator({ current, previous, label, format }) {
  if (previous == null || current == null) return null
  const diff = current - previous
  if (Math.abs(diff) < 0.001) return null

  const isUp = diff > 0
  const arrow = isUp ? '\u2191' : '\u2193'
  const color = isUp ? theme.green : theme.red
  const formatted = format ? format(Math.abs(diff)) : Math.abs(diff)

  return (
    <span style={{ ...styles.trend, color }} title={`Change from previous snapshot`}>
      {arrow} {formatted}
    </span>
  )
}

function StatCard({ label, value, subtle, trend }) {
  return (
    <div style={subtle ? styles.cardSubtle : styles.card}>
      <div style={styles.valueRow}>
        <div style={styles.value}>{value}</div>
        {trend}
      </div>
      <div style={styles.label}>{label}</div>
    </div>
  )
}

function RateCard({ label, value, previousValue }) {
  const pct = (value * 100).toFixed(1)
  return (
    <div style={styles.rateCard}>
      <div style={styles.rateValue}>{pct}%</div>
      <div style={styles.rateLabel}>{label}</div>
      <TrendIndicator
        current={value}
        previous={previousValue}
        format={v => `${(v * 100).toFixed(1)}%`}
      />
    </div>
  )
}

function SnapshotTimeline({ snapshots }) {
  if (!snapshots || snapshots.length === 0) return null
  // Show last 10
  const recent = snapshots.slice(-10)

  return (
    <div style={styles.timelineSection}>
      <h3 style={styles.heading}>Snapshot History</h3>
      <div style={styles.timelineStrip}>
        {recent.map((s, i) => {
          const ts = new Date(s.timestamp)
          const timeStr = ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
          const dateStr = ts.toLocaleDateString([], { month: 'short', day: 'numeric' })
          return (
            <div key={i} style={styles.timelineItem} title={s.timestamp}>
              <div style={styles.timelineDot} />
              <div style={styles.timelineDate}>{dateStr}</div>
              <div style={styles.timelineTime}>{timeStr}</div>
              <div style={styles.timelineStat}>{s.issues_completed} done</div>
              <div style={styles.timelineStat}>{s.prs_merged} merged</div>
            </div>
          )
        })}
      </div>
    </div>
  )
}

export function MetricsPanel() {
  const {
    metrics, lifetimeStats, githubMetrics, metricsHistory, stageStatus,
  } = useHydraFlow()
  const sessionTriaged = stageStatus?.triage?.sessionCount || 0
  const sessionPlanned = stageStatus?.plan?.sessionCount || 0
  const sessionImplemented = stageStatus?.implement?.sessionCount || 0
  const sessionReviewed = stageStatus?.review?.sessionCount || 0
  const mergedCount = stageStatus?.merged?.sessionCount || 0
  const github = githubMetrics || {}
  const openByLabel = github.open_by_label || {}
  const lifetime = metrics?.lifetime || lifetimeStats || {}

  const hasGithub = githubMetrics !== null && githubMetrics !== undefined
  const hasSession = sessionTriaged > 0 || sessionPlanned > 0 ||
    sessionImplemented > 0 || sessionReviewed > 0 || mergedCount > 0
  const hasLifetime = hasGithub || lifetime.issues_completed > 0 ||
    lifetime.prs_merged > 0

  // Extract history data
  const historyData = metricsHistory || {}
  const snapshots = historyData.snapshots || []
  const current = historyData.current
  const prev = snapshots.length > 0 ? snapshots[snapshots.length - 1] : null

  if (!hasGithub && !hasSession && !hasLifetime && !current) {
    return (
      <div style={styles.container}>
        <div style={styles.empty}>No metrics data available yet.</div>
      </div>
    )
  }

  return (
    <div style={styles.container}>
      <h3 style={styles.heading}>Lifetime</h3>
      <div style={styles.row}>
        <StatCard
          label="Issues Completed"
          value={github.total_closed ?? lifetime.issues_completed ?? 0}
          trend={<TrendIndicator
            current={current?.issues_completed}
            previous={prev?.issues_completed}
          />}
        />
        <StatCard
          label="PRs Merged"
          value={github.total_merged ?? lifetime.prs_merged ?? 0}
          trend={<TrendIndicator
            current={current?.prs_merged}
            previous={prev?.prs_merged}
          />}
        />
        {hasGithub && (
          <StatCard
            label="Open Issues"
            value={Object.values(openByLabel).reduce((a, b) => a + b, 0)}
          />
        )}
      </div>

      {(current || prev) && (
        <>
          <h3 style={styles.heading}>Rates</h3>
          <div style={styles.row}>
            <RateCard
              label="Merge Rate"
              value={current?.merge_rate ?? 0}
              previousValue={prev?.merge_rate}
            />
            <RateCard
              label="First-Pass Approval"
              value={current?.first_pass_approval_rate ?? 0}
              previousValue={prev?.first_pass_approval_rate}
            />
            <RateCard
              label="Quality Fix Rate"
              value={current?.quality_fix_rate ?? 0}
              previousValue={prev?.quality_fix_rate}
            />
            <RateCard
              label="HITL Escalation"
              value={current?.hitl_escalation_rate ?? 0}
              previousValue={prev?.hitl_escalation_rate}
            />
          </div>
        </>
      )}

      {hasSession && (
        <>
          <h3 style={styles.heading}>Session</h3>
          <div style={styles.row}>
            <StatCard label="Triaged" value={sessionTriaged || 0} subtle />
            <StatCard label="Planned" value={sessionPlanned || 0} subtle />
            <StatCard label="Implemented" value={sessionImplemented || 0} subtle />
            <StatCard label="Reviewed" value={sessionReviewed || 0} subtle />
            <StatCard label="Merged" value={mergedCount || 0} subtle />
          </div>
        </>
      )}

      <SnapshotTimeline snapshots={snapshots} />

    </div>
  )
}

const styles = {
  container: {
    flex: 1,
    overflowY: 'auto',
    padding: 20,
  },
  heading: {
    fontSize: 16,
    fontWeight: 600,
    color: theme.textBright,
    marginBottom: 16,
    marginTop: 0,
  },
  row: {
    display: 'flex',
    gap: 16,
    marginBottom: 24,
    flexWrap: 'wrap',
  },
  card: {
    border: `1px solid ${theme.border}`,
    borderRadius: 8,
    padding: 20,
    background: theme.surface,
    minWidth: 140,
    textAlign: 'center',
  },
  cardSubtle: {
    border: `1px solid ${theme.border}`,
    borderRadius: 8,
    padding: 16,
    background: theme.surfaceInset,
    minWidth: 100,
    textAlign: 'center',
  },
  valueRow: {
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 6,
  },
  value: {
    fontSize: 32,
    fontWeight: 700,
    color: theme.textBright,
    marginBottom: 4,
  },
  label: {
    fontSize: 12,
    color: theme.textMuted,
    textTransform: 'capitalize',
  },
  trend: {
    fontSize: 12,
    fontWeight: 600,
  },
  empty: {
    fontSize: 13,
    color: theme.textMuted,
    padding: 20,
  },
  rateCard: {
    border: `1px solid ${theme.border}`,
    borderRadius: 8,
    padding: 16,
    background: theme.surface,
    minWidth: 120,
    textAlign: 'center',
  },
  rateValue: {
    fontSize: 24,
    fontWeight: 700,
    color: theme.textBright,
    marginBottom: 4,
  },
  rateLabel: {
    fontSize: 11,
    color: theme.textMuted,
    marginBottom: 4,
  },
  timelineSection: {
    marginTop: 8,
  },
  timelineStrip: {
    display: 'flex',
    gap: 12,
    overflowX: 'auto',
    paddingBottom: 8,
  },
  timelineItem: {
    display: 'flex',
    flexDirection: 'column',
    alignItems: 'center',
    gap: 4,
    minWidth: 80,
    padding: '8px 12px',
    background: theme.surfaceInset,
    borderRadius: 8,
    border: `1px solid ${theme.border}`,
  },
  timelineDot: {
    width: 8,
    height: 8,
    borderRadius: '50%',
    background: theme.accent,
  },
  timelineDate: {
    fontSize: 10,
    fontWeight: 600,
    color: theme.textMuted,
  },
  timelineTime: {
    fontSize: 10,
    color: theme.textInactive,
  },
  timelineStat: {
    fontSize: 10,
    color: theme.textMuted,
  },
}
