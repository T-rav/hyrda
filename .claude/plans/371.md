# Issue #371: Show disabled stage indicators and status dots in Work Stream

## Restatement

When a pipeline stage (triage, plan, implement, review) is toggled off via the System tab, the Work Stream tab currently shows **no visual indication** that the stage is disabled. This issue adds:
1. A **green/yellow/red status dot** (8px) to each stage header showing health
2. An **active worker count** next to the dot
3. **Opacity dimming + "Disabled" badge** when a stage is toggled off

## Files to Modify

### `ui/src/components/StreamView.jsx`
- Pull `backgroundWorkers` from `useHydraFlow()` context
- Compute per-stage enabled state from `backgroundWorkers` array
- Pass `enabled` flag and `activeWorkerCount` to `StageSection`
- Add status dot (8px circle) to stage header with green/yellow/red coloring
- Add worker count display next to the dot
- Add "Disabled" text badge when stage is disabled
- Apply reduced opacity (0.5) to entire `StageSection` when disabled
- Add new styles: `statusDot`, `workerCountText`, `disabledBadge`, `sectionDisabled`
- Update pre-computed `sectionHeaderStyles` to accommodate new elements

### `ui/src/components/__tests__/StreamView.test.jsx` (NEW)
- Test status dot colors (green/yellow/red) based on enabled state and worker counts
- Test "Disabled" badge visibility when stage is off
- Test opacity dimming on disabled stages
- Test worker count display
- Test that toggling a stage back on restores full opacity

## New Files

### `ui/src/components/__tests__/StreamView.test.jsx`
New test file for StreamView component, following the pattern established by `SystemPanel.test.jsx` (mock `useHydraFlow`, render with test data, assert DOM state).

## Implementation Steps

1. **Add `backgroundWorkers` to StreamView's data flow**
   - In `StreamView` component (`StreamView.jsx:92`), destructure `backgroundWorkers` from `useHydraFlow()` alongside existing `pipelineIssues`, `workers`, `prs`
   - Compute a `stageEnabled` map using `useMemo` — for each `PIPELINE_STAGES` entry that has a corresponding `PIPELINE_LOOPS` key, check if `backgroundWorkers.find(w => w.name === stage.key)?.enabled !== false` (default to `true` if no worker state exists, matching SystemPanel's behavior)

2. **Compute stage status info (dot color + active count)**
   - Create a `stageStatusInfo` `useMemo` that, for each stage with a `role`, computes:
     - `enabled`: from `stageEnabled` map
     - `activeCount`: from existing `workerCounts` (already computed at line 150-159)
     - `dotColor`: Red if `!enabled`, Green if `activeCount > 0`, Yellow otherwise
   - Use `theme.green`, `theme.yellow`, `theme.red` from `theme.js`

3. **Pass status props to `StageSection`**
   - Add `stageEnabled` and `stageStatusInfo` as props to `StageSection` (or pass computed `dotColor`, `activeWorkerCount`, `enabled`)
   - Update `StageSection` function signature to accept: `enabled`, `dotColor`, `activeWorkerCount`

4. **Add status dot to stage header**
   - Inside `StageSection`'s header div (line 26-36), add an 8px circle `<span>` at the end of the row (after the count span)
   - Style: `width: 8, height: 8, borderRadius: '50%', flexShrink: 0`, with `background` set to `dotColor`
   - Add `data-testid={`stage-dot-${stage.key}`}` for testing
   - Only render dot for stages with a `role` (skip "merged")

5. **Add worker count next to dot**
   - After the dot, add a `<span>` showing `activeWorkerCount` (e.g., `● 3`)
   - Style: `fontSize: 10, color: theme.textMuted, fontWeight: 600`
   - Only show when `activeWorkerCount > 0` to avoid clutter
   - Add `data-testid={`stage-workers-${stage.key}`}` for testing

6. **Add disabled dimming and badge**
   - Wrap `StageSection`'s root `<div>` style to include `opacity: enabled ? 1 : 0.5` and `transition: 'opacity 0.2s'`
   - When `!enabled`, add a "Disabled" text badge span after the stage label
   - Badge style: `fontSize: 9, fontWeight: 600, color: theme.red, background: theme.redSubtle, border: \`1px solid ${theme.red}\`, borderRadius: 10, padding: '1px 6px', textTransform: 'uppercase'` — matching the existing pill pattern from SystemPanel (line 490-508)

7. **Update pre-computed styles**
   - Add `statusDot`, `workerCountText`, `disabledBadge` to the `styles` object at file bottom
   - Keep styles static/pre-computed to follow the existing pattern (no object spread in render)

8. **Write comprehensive tests** (`ui/src/components/__tests__/StreamView.test.jsx`)
   - Mock `useHydra` to return controlled `pipelineIssues`, `workers`, `prs`, `backgroundWorkers`
   - Test: green dot when stage has active workers
   - Test: yellow dot when stage enabled but no active workers
   - Test: red dot when stage disabled
   - Test: "Disabled" badge appears when stage is off
   - Test: section opacity is 0.5 when disabled
   - Test: section opacity is 1 when enabled
   - Test: worker count shows correct number
   - Test: worker count hidden when zero
   - Test: no dot rendered for "merged" stage (no role)

## Testing Strategy

### Test file: `ui/src/components/__tests__/StreamView.test.jsx`

**Setup pattern** (mirroring `SystemPanel.test.jsx`):
- Mock `useHydraFlow` via `vi.mock('../../context/HydraFlowContext')`
- Mock `useTimeline` hook (imported in `StreamView` via `STAGE_KEYS`)
- Create fixture data for `pipelineIssues`, `workers`, `backgroundWorkers`

**Test cases**:

1. **Status dot colors**:
   - Render with `backgroundWorkers: [{ name: 'triage', enabled: true }]` and active triage workers → assert `stage-dot-triage` has `background: var(--green)`
   - Render with enabled stage but no workers → assert `stage-dot-plan` has `background: var(--yellow)`
   - Render with `backgroundWorkers: [{ name: 'implement', enabled: false }]` → assert `stage-dot-implement` has `background: var(--red)`

2. **Disabled badge**:
   - Render with disabled stage → assert "Disabled" text is in document
   - Render with enabled stage → assert "Disabled" text is NOT in document

3. **Opacity dimming**:
   - Render with disabled stage → assert section container has `opacity: 0.5`
   - Render with enabled stage → assert section container has `opacity: 1` (or default)

4. **Worker count display**:
   - Render with 2 active workers → assert `stage-workers-implement` shows "2"
   - Render with 0 workers → assert `stage-workers-implement` is not in document

5. **Merged stage exclusion**:
   - Assert no `stage-dot-merged` element exists (merged has no role/toggle)

**Run with**: `make test` or `cd ui && npx vitest run src/components/__tests__/StreamView.test.jsx`

## Acceptance Criteria

- [x] Each Work Stream stage header shows a green/yellow/red status dot
- [x] Green = workers actively processing, Yellow = enabled but idle, Red = disabled
- [x] Active worker count displayed next to the dot
- [x] When a stage is disabled via System tab, Work Stream dims that stage section (reduced opacity)
- [x] A "Disabled" indicator is visible on disabled stages
- [x] Toggling a stage back on immediately restores full opacity
- [x] All existing tests pass (`make quality`)

## Key Considerations

### Data source for enabled state
The issue mentions dependency on #370 (centralized `stageStatus` model), but #370 has NOT been implemented yet. The `backgroundWorkers` array in HydraFlowContext already contains the enabled/disabled state for each pipeline loop (set by `TOGGLE_BG_WORKER` reducer). We can derive enabled state directly from `backgroundWorkers` — the same data source `SystemPanel` uses. This avoids blocking on #370. If #370 lands later, we can refactor to use `stageStatus` instead.

### Merged stage handling
The "merged" stage has `role: null` and no corresponding `PIPELINE_LOOPS` entry. It should NOT show a status dot, worker count, or disabled state — it's a terminal state, not a toggleable processing stage.

### Default enabled state
When no `backgroundWorkers` entry exists for a stage (e.g., fresh app start before backend reports), default to `enabled: true`. This matches SystemPanel's behavior (`const enabled = !isSystem && (state ? state.enabled !== false : true)` at line 146).

### Pre-mortem: Top 3 failure risks

1. **Data timing**: `backgroundWorkers` array may be empty on initial render (before WebSocket connects). The `stageEnabled` computation must default to `true` when no entry exists, otherwise all stages flash as "Disabled" momentarily on load.

2. **Style pre-computation conflict**: The existing `sectionHeaderStyles` are pre-computed outside the component using `Object.fromEntries(PIPELINE_STAGES.map(...))`. The new opacity dimming needs to be dynamic (depends on runtime `enabled` state), so it must be applied via inline style on the section wrapper `<div>`, not added to the pre-computed styles. Mixing pre-computed + dynamic styles requires care to avoid breaking the existing pattern.

3. **Test mock complexity**: `StreamView` uses `useHydraFlow()` for `pipelineIssues`, `workers`, `prs`, AND now `backgroundWorkers`. The mock must return all of these. If any field is missing, the component will crash with undefined errors. The test fixtures must be comprehensive.
