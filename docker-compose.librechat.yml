name: librechat

services:
  # MongoDB for LibreChat user data
  librechat-mongodb:
    image: mongo:latest
    container_name: librechat-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - librechat_mongodb_data:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=${LIBRECHAT_MONGO_PASSWORD:-librechat_mongo_pass}
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - insightmesh
      - librechat

  # LibreChat UI
  librechat:
    image: ghcr.io/danny-avila/librechat:latest
    container_name: librechat
    restart: unless-stopped
    ports:
      - "3080:3080"
    depends_on:
      librechat-mongodb:
        condition: service_healthy
    env_file:
      - .env
    environment:
      # MongoDB Configuration
      - MONGO_URI=mongodb://admin:${LIBRECHAT_MONGO_PASSWORD:-librechat_mongo_pass}@librechat-mongodb:27017/LibreChat?authSource=admin

      # App Configuration
      - HOST=0.0.0.0
      - PORT=3080
      - DOMAIN_CLIENT=${LIBRECHAT_DOMAIN_CLIENT:-http://localhost:3080}
      - DOMAIN_SERVER=${LIBRECHAT_DOMAIN_SERVER:-http://localhost:3080}

      # Session & Security
      - JWT_SECRET=${LIBRECHAT_JWT_SECRET:-}
      - JWT_REFRESH_SECRET=${LIBRECHAT_JWT_REFRESH_SECRET:-}
      - CREDS_KEY=${LIBRECHAT_CREDS_KEY:-}
      - CREDS_IV=${LIBRECHAT_CREDS_IV:-}

      # OAuth Configuration (Google for InsightMesh SSO)
      - GOOGLE_CLIENT_ID=${GOOGLE_OAUTH_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_OAUTH_CLIENT_SECRET:-}
      - GOOGLE_CALLBACK_URL=${LIBRECHAT_DOMAIN_SERVER:-http://localhost:3080}/oauth/google/callback

      # InsightMesh RAG Service Integration
      - RAG_API_URL=http://insightmesh-rag-service:8002
      - AGENT_SERVICE_URL=http://insightmesh-agent-service:8000
      - CONTROL_PLANE_URL=http://insightmesh-control-plane:6001

      # LLM Provider Configuration (inherit from main .env)
      - ANTHROPIC_API_KEY=${LLM_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}

      # Feature Flags
      - ALLOW_REGISTRATION=${LIBRECHAT_ALLOW_REGISTRATION:-true}
      - ALLOW_UNVERIFIED_EMAIL_LOGIN=${LIBRECHAT_ALLOW_UNVERIFIED_EMAIL_LOGIN:-true}
      - ALLOW_SOCIAL_LOGIN=${LIBRECHAT_ALLOW_SOCIAL_LOGIN:-true}

    volumes:
      - librechat_data:/app/client/public/images
      - librechat_logs:/app/api/logs
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - insightmesh
      - librechat
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "{{.Name}}"
    labels:
      logging: "promtail"
      service: "librechat"
      component: "ui"

volumes:
  librechat_mongodb_data:
    driver: local
  librechat_data:
    driver: local
  librechat_logs:
    driver: local

networks:
  librechat:
    name: librechat
    driver: bridge
  insightmesh:
    external: true
    name: insightmesh
