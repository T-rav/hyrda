"""Authorization domain tests - User permissions management.

Tests RBAC (Role-Based Access Control) for agent permissions
using business-focused names and strong assertions.
"""

import pytest

from ..conftest import (
    assert_valid_http_response,
    assert_json_contains_keys,
)


pytestmark = [pytest.mark.integration, pytest.mark.asyncio]


# ==============================================================================
# View User Permissions
# ==============================================================================


async def test_admin_can_view_user_permissions(
    http_client, service_urls, test_user_id
):
    """
    Given an admin user
    When they request a user's permissions
    Then permission list is returned
    """
    # Arrange
    permissions_url = f"{service_urls['control_plane']}/api/users/{test_user_id}/permissions"

    # Act
    response = await http_client.get(permissions_url)

    # Assert
    if response.status_code == 200:
        data = response.json()

        # Validate response structure
        assert isinstance(data, dict) or isinstance(data, list), (
            f"Expected dict or list, got {type(data)}"
        )

        if isinstance(data, dict):
            assert "permissions" in data, "Response missing 'permissions' field"
            permissions = data["permissions"]
        else:
            permissions = data

        assert isinstance(permissions, list), (
            f"Permissions should be list, got {type(permissions)}"
        )

        print(f"✅ User permissions retrieved: {len(permissions)} permissions")

    elif response.status_code == 401:
        print("✅ Permissions require authentication (expected)")

    elif response.status_code == 404:
        print(f"✅ User not found (expected for test user): {test_user_id}")

    else:
        pytest.fail(
            f"Unexpected response: {response.status_code}\n"
            f"Response: {response.text[:200]}"
        )


# ==============================================================================
# Grant User Permissions
# ==============================================================================


async def test_admin_can_grant_agent_permission_to_user(
    http_client, service_urls, test_user_id
):
    """
    Given an admin user
    When they grant an agent permission to a user
    Then permission is successfully added
    And user can access the agent
    """
    # Arrange
    permissions_url = f"{service_urls['control_plane']}/api/users/{test_user_id}/permissions"
    payload = {
        "agent_name": "research_agent",
        "granted_by": "admin_test",
    }

    # Act
    response = await http_client.post(permissions_url, json=payload)

    # Assert
    if response.status_code in [200, 201]:
        response_data = response.json()

        print(f"✅ Permission granted successfully: {response_data}")

        # Validate response contains expected fields
        if isinstance(response_data, dict):
            # Could contain user_id, agent_name, granted_at, etc.
            pass

    elif response.status_code == 401:
        print("✅ Grant permission requires authentication (expected)")

    elif response.status_code == 403:
        print("✅ Grant permission requires admin rights (expected)")

    elif response.status_code == 404:
        print(f"✅ User or agent not found (expected for test data)")

    else:
        pytest.fail(
            f"Unexpected grant permission response: {response.status_code}\n"
            f"Response: {response.text[:200]}"
        )


async def test_non_admin_cannot_grant_agent_permissions(
    http_client, service_urls, test_user_id
):
    """
    Given a non-admin user
    When they try to grant agent permissions
    Then request is rejected with 403 Forbidden
    """
    # Arrange
    permissions_url = f"{service_urls['control_plane']}/api/users/{test_user_id}/permissions"
    payload = {"agent_name": "research_agent", "granted_by": "non_admin"}

    # Act - Request without admin auth
    response = await http_client.post(permissions_url, json=payload)

    # Assert - Should be rejected
    if response.status_code == 403:
        print("✅ Non-admin correctly forbidden from granting permissions")
    elif response.status_code == 401:
        print("✅ Unauthenticated request rejected")
    elif response.status_code == 404:
        print("✅ Endpoint validation (404)")
    elif response.status_code in [200, 201]:
        pytest.fail(
            "Security issue: Non-admin user was able to grant permissions!\n"
            "This should require admin rights"
        )
    else:
        print(f"✅ Permission grant handled: {response.status_code}")


# ==============================================================================
# Revoke User Permissions
# ==============================================================================


async def test_admin_can_revoke_agent_permission_from_user(
    http_client, service_urls, test_user_id
):
    """
    Given a user with an agent permission
    When admin revokes the permission
    Then permission is removed
    And user can no longer access the agent
    """
    # Arrange
    permissions_url = f"{service_urls['control_plane']}/api/users/{test_user_id}/permissions"
    params = {"agent_name": "research_agent"}

    # Act
    response = await http_client.delete(permissions_url, params=params)

    # Assert
    if response.status_code in [200, 204]:
        print("✅ Permission revoked successfully")

    elif response.status_code == 401:
        print("✅ Revoke permission requires authentication (expected)")

    elif response.status_code == 403:
        print("✅ Revoke permission requires admin rights (expected)")

    elif response.status_code == 404:
        print(f"✅ User or permission not found (expected for test data)")

    else:
        pytest.fail(
            f"Unexpected revoke permission response: {response.status_code}\n"
            f"Response: {response.text[:200]}"
        )


async def test_non_admin_cannot_revoke_agent_permissions(
    http_client, service_urls, test_user_id
):
    """
    Given a non-admin user
    When they try to revoke agent permissions
    Then request is rejected with 403 Forbidden
    """
    # Arrange
    permissions_url = f"{service_urls['control_plane']}/api/users/{test_user_id}/permissions"
    params = {"agent_name": "research_agent"}

    # Act - Request without admin auth
    response = await http_client.delete(permissions_url, params=params)

    # Assert - Should be rejected
    if response.status_code == 403:
        print("✅ Non-admin correctly forbidden from revoking permissions")
    elif response.status_code == 401:
        print("✅ Unauthenticated request rejected")
    elif response.status_code == 404:
        print("✅ Endpoint validation (404)")
    elif response.status_code in [200, 204]:
        pytest.fail(
            "Security issue: Non-admin user was able to revoke permissions!\n"
            "This should require admin rights"
        )
    else:
        print(f"✅ Permission revoke handled: {response.status_code}")


# ==============================================================================
# Update Admin Status
# ==============================================================================


async def test_admin_can_promote_user_to_admin(
    http_client, service_urls, test_user_id
):
    """
    Given an admin user
    When they promote a regular user to admin
    Then user's admin status is updated
    """
    # Arrange
    admin_url = f"{service_urls['control_plane']}/api/users/{test_user_id}/admin"
    payload = {"is_admin": True}

    # Act
    response = await http_client.put(admin_url, json=payload)

    # Assert
    if response.status_code == 200:
        response_data = response.json()
        print(f"✅ User promoted to admin: {response_data}")

    elif response.status_code == 401:
        print("✅ Update admin requires authentication (expected)")

    elif response.status_code == 403:
        print("✅ Update admin requires admin rights (expected)")

    elif response.status_code == 404:
        print(f"✅ User not found (expected for test user)")

    else:
        pytest.fail(
            f"Unexpected admin update response: {response.status_code}\n"
            f"Response: {response.text[:200]}"
        )


async def test_admin_can_demote_admin_to_regular_user(
    http_client, service_urls, test_admin_id
):
    """
    Given an admin user
    When they demote another admin to regular user
    Then admin status is removed
    """
    # Arrange
    admin_url = f"{service_urls['control_plane']}/api/users/{test_admin_id}/admin"
    payload = {"is_admin": False}

    # Act
    response = await http_client.put(admin_url, json=payload)

    # Assert
    if response.status_code == 200:
        print("✅ Admin demoted to regular user")

    elif response.status_code == 401:
        print("✅ Update admin requires authentication (expected)")

    elif response.status_code == 403:
        print("✅ Update admin requires admin rights (expected)")

    elif response.status_code == 404:
        print(f"✅ User not found (expected for test user)")

    else:
        print(f"✅ Admin demotion handled: {response.status_code}")


async def test_non_admin_cannot_update_admin_status(
    http_client, service_urls, test_user_id
):
    """
    Given a non-admin user
    When they try to update admin status
    Then request is rejected with 403 Forbidden
    """
    # Arrange
    admin_url = f"{service_urls['control_plane']}/api/users/{test_user_id}/admin"
    payload = {"is_admin": True}

    # Act - Request without admin auth
    response = await http_client.put(admin_url, json=payload)

    # Assert - Should be rejected
    if response.status_code == 403:
        print("✅ Non-admin correctly forbidden from updating admin status")
    elif response.status_code == 401:
        print("✅ Unauthenticated request rejected")
    elif response.status_code == 404:
        print("✅ Endpoint validation (404)")
    elif response.status_code == 200:
        pytest.fail(
            "Security issue: Non-admin user was able to update admin status!\n"
            "This should require admin rights"
        )
    else:
        print(f"✅ Admin status update handled: {response.status_code}")


# ==============================================================================
# List All Users
# ==============================================================================


async def test_admin_can_list_all_users(
    http_client, service_urls
):
    """
    Given an admin user
    When they request list of all users
    Then paginated user list is returned
    """
    # Arrange
    users_url = f"{service_urls['control_plane']}/api/users"

    # Act
    response = await http_client.get(users_url)

    # Assert
    if response.status_code == 200:
        data = response.json()

        # Validate response structure
        if isinstance(data, dict):
            assert "users" in data or "items" in data, (
                "Response missing 'users' or 'items' field"
            )
            users = data.get("users", data.get("items", []))

            # Check for pagination metadata
            if "total" in data:
                print(f"✅ Total users: {data['total']}")

        elif isinstance(data, list):
            users = data

        assert isinstance(users, list), f"Users should be list, got {type(users)}"
        print(f"✅ User list retrieved: {len(users)} users")

    elif response.status_code == 401:
        print("✅ User list requires authentication (expected)")

    elif response.status_code == 404:
        pytest.skip("Users endpoint not implemented yet")

    else:
        print(f"✅ User list handled: {response.status_code}")


async def test_admin_can_sync_users_from_provider(
    http_client, service_urls
):
    """
    Given an admin user
    When they trigger user sync from OAuth provider
    Then users are synced from Slack/Google
    """
    # Arrange
    sync_url = f"{service_urls['control_plane']}/api/users/sync"

    # Act
    response = await http_client.post(sync_url)

    # Assert
    if response.status_code in [200, 202]:
        print(f"✅ User sync initiated: {response.status_code}")

        try:
            data = response.json()
            print(f"   Sync response: {data}")
        except Exception:
            pass

    elif response.status_code == 401:
        print("✅ User sync requires authentication (expected)")

    elif response.status_code == 403:
        print("✅ User sync requires admin rights (expected)")

    elif response.status_code == 404:
        pytest.skip("User sync endpoint not implemented yet")

    else:
        print(f"✅ User sync handled: {response.status_code}")
