<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hydra Dashboard</title>
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --green: #3fb950;
      --red: #f85149;
      --yellow: #d29922;
      --orange: #d18616;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace;
      background: var(--bg);
      color: var(--text);
      font-size: 13px;
      line-height: 1.5;
    }

    /* Layout */
    .layout {
      display: grid;
      grid-template-rows: auto 1fr;
      grid-template-columns: 280px 1fr 320px;
      height: 100vh;
    }

    header {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    .logo {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }

    .logo span { color: var(--text-muted); font-weight: 400; font-size: 12px; margin-left: 8px; }

    .header-stats {
      display: flex;
      gap: 20px;
      font-size: 12px;
    }

    .stat { color: var(--text-muted); }
    .stat b { color: var(--text); }

    .phase-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      background: var(--accent);
      color: var(--bg);
    }

    .phase-badge.implement { background: var(--yellow); }
    .phase-badge.review { background: var(--orange); }
    .phase-badge.merge { background: var(--green); }
    .phase-badge.done { background: var(--green); }
    .phase-badge.failed { background: var(--red); }

    /* Sidebar ‚Äî Workers */
    .sidebar {
      border-right: 1px solid var(--border);
      overflow-y: auto;
      background: var(--surface);
    }

    .sidebar-title {
      padding: 12px 16px 8px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.5px;
    }

    .worker-card {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.15s;
    }

    .worker-card:hover, .worker-card.active {
      background: rgba(88, 166, 255, 0.08);
    }

    .worker-card.active {
      border-left: 3px solid var(--accent);
      padding-left: 13px;
    }

    .worker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .worker-issue {
      font-weight: 600;
      color: var(--text);
    }

    .worker-status {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 8px;
      font-weight: 600;
    }

    .worker-status.running { background: rgba(88, 166, 255, 0.15); color: var(--accent); }
    .worker-status.testing { background: rgba(210, 153, 34, 0.15); color: var(--yellow); }
    .worker-status.done { background: rgba(63, 185, 80, 0.15); color: var(--green); }
    .worker-status.failed { background: rgba(248, 81, 73, 0.15); color: var(--red); }
    .worker-status.queued { background: rgba(139, 148, 158, 0.15); color: var(--text-muted); }
    .worker-status.committing { background: rgba(210, 134, 22, 0.15); color: var(--orange); }

    .worker-title {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .worker-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Main content ‚Äî Transcript */
    .main {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }

    .tab {
      padding: 10px 20px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
    }

    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    .transcript {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      font-size: 12px;
      line-height: 1.6;
    }

    .transcript-line {
      padding: 1px 0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .transcript-line.new {
      animation: flash 0.5s ease;
    }

    @keyframes flash {
      0% { background: rgba(88, 166, 255, 0.15); }
      100% { background: transparent; }
    }

    /* Right panel ‚Äî Events / PRs */
    .right-panel {
      border-left: 1px solid var(--border);
      overflow-y: auto;
      background: var(--surface);
    }

    .event-log {
      padding: 8px;
    }

    .event-item {
      padding: 6px 8px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
    }

    .event-time {
      color: var(--text-muted);
      margin-right: 8px;
    }

    .event-type {
      font-weight: 600;
      margin-right: 6px;
    }

    .event-type.worker_update { color: var(--accent); }
    .event-type.phase_change { color: var(--yellow); }
    .event-type.pr_created { color: var(--green); }
    .event-type.review_update { color: var(--orange); }
    .event-type.merge_update { color: var(--green); }
    .event-type.error { color: var(--red); }

    /* Human Input Banner */
    .human-input-banner {
      display: none;
      padding: 12px 16px;
      background: rgba(210, 153, 34, 0.15);
      border-bottom: 2px solid var(--yellow);
      align-items: center;
      gap: 12px;
    }

    .human-input-banner.visible { display: flex; }

    .human-input-banner .question {
      flex: 1;
      color: var(--yellow);
      font-weight: 600;
    }

    .human-input-banner input {
      flex: 2;
      padding: 6px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: inherit;
      font-size: 12px;
    }

    .human-input-banner button {
      padding: 6px 16px;
      background: var(--yellow);
      color: var(--bg);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }

    /* PR table */
    .pr-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .pr-table th {
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 11px;
    }

    .pr-table td {
      padding: 8px;
      border-bottom: 1px solid var(--border);
    }

    /* Empty state */
    .empty-state {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <div>
        <span class="logo">HYDRA <span>Parallel Issue Processor</span></span>
      </div>
      <div class="header-stats">
        <span class="stat">Batch <b id="batch-num">0</b></span>
        <span class="stat">Workers <b id="workers-active">0</b>/<b id="workers-total">0</b></span>
        <span class="stat">PRs <b id="prs-count">0</b></span>
        <span class="stat">Merged <b id="merged-count">0</b></span>
      </div>
      <span class="phase-badge" id="phase-badge">idle</span>
    </header>

    <div class="sidebar">
      <div class="sidebar-title">Workers</div>
      <div id="worker-list">
        <div class="empty-state" style="height:200px;">Waiting for issues...</div>
      </div>
    </div>

    <div class="main">
      <div class="human-input-banner" id="human-input-banner">
        <span class="question" id="human-input-question">Agent needs input:</span>
        <input type="text" id="human-input-field" placeholder="Type your response..." />
        <button onclick="submitHumanInput()">Send</button>
      </div>
      <div class="tabs">
        <div class="tab active" onclick="switchTab('transcript')">Transcript</div>
        <div class="tab" onclick="switchTab('prs')">Pull Requests</div>
        <div class="tab" onclick="switchTab('reviews')">Reviews</div>
        <div class="tab" onclick="switchTab('timeline')">Timeline</div>
      </div>
      <div id="tab-transcript" class="transcript">
        <div class="empty-state">Select a worker to view its transcript</div>
      </div>
      <div id="tab-prs" class="transcript" style="display:none;">
        <table class="pr-table">
          <thead><tr><th>PR</th><th>Issue</th><th>Branch</th><th>Status</th></tr></thead>
          <tbody id="pr-tbody"></tbody>
        </table>
      </div>
      <div id="tab-reviews" class="transcript" style="display:none;">
        <table class="pr-table">
          <thead><tr><th>PR</th><th>Verdict</th><th>Summary</th></tr></thead>
          <tbody id="review-tbody"></tbody>
        </table>
      </div>
      <div id="tab-timeline" class="transcript" style="display:none;">
        <div id="timeline-content" class="event-log"></div>
      </div>
    </div>

    <div class="right-panel">
      <div class="sidebar-title">Event Log</div>
      <div id="event-log" class="event-log"></div>
    </div>
  </div>

  <script>
    // State
    const workers = {};       // {issueNum: {status, title, branch, transcript[]}}
    const prs = [];           // [{pr, issue, branch, draft, url}]
    const reviews = [];       // [{pr, verdict, summary}]
    let selectedWorker = null;
    let currentTab = 'transcript';

    // WebSocket
    const wsUrl = `ws://${location.host}/ws`;
    let ws = null;

    function connect() {
      ws = new WebSocket(wsUrl);
      ws.onmessage = (e) => handleEvent(JSON.parse(e.data));
      ws.onclose = () => setTimeout(connect, 2000);
      ws.onerror = () => ws.close();
    }
    connect();

    // Poll for human input requests
    setInterval(async () => {
      try {
        const resp = await fetch('/api/human-input');
        const data = await resp.json();
        const banner = document.getElementById('human-input-banner');
        const keys = Object.keys(data);
        if (keys.length > 0) {
          const issueNum = keys[0];
          const question = data[issueNum];
          document.getElementById('human-input-question').textContent =
            `Issue #${issueNum}: ${question}`;
          document.getElementById('human-input-field').dataset.issue = issueNum;
          banner.classList.add('visible');
        } else {
          banner.classList.remove('visible');
        }
      } catch (e) { /* ignore */ }
    }, 3000);

    async function submitHumanInput() {
      const field = document.getElementById('human-input-field');
      const issueNum = field.dataset.issue;
      const answer = field.value.trim();
      if (!answer || !issueNum) return;

      await fetch(`/api/human-input/${issueNum}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ answer }),
      });
      field.value = '';
      document.getElementById('human-input-banner').classList.remove('visible');
    }

    function handleEvent(event) {
      const { type, data, timestamp } = event;

      // Update event log
      addEventLog(type, data, timestamp);

      switch (type) {
        case 'batch_start':
          document.getElementById('batch-num').textContent = data.batch;
          break;

        case 'phase_change':
          const badge = document.getElementById('phase-badge');
          badge.textContent = data.phase;
          badge.className = 'phase-badge ' + data.phase;
          break;

        case 'worker_update':
          updateWorker(data.issue, data.status, data.worker);
          break;

        case 'transcript_line':
          const issueNum = data.issue || data.pr;
          if (issueNum && workers[issueNum]) {
            workers[issueNum].transcript.push(data.line);
            if (selectedWorker === issueNum) {
              appendTranscriptLine(data.line);
            }
          }
          break;

        case 'pr_created':
          prs.push(data);
          document.getElementById('prs-count').textContent = prs.length;
          updatePRTable();
          if (data.issue && workers[data.issue]) {
            workers[data.issue].pr = data;
          }
          break;

        case 'review_update':
          if (data.status === 'done') {
            reviews.push(data);
            updateReviewTable();
          }
          break;

        case 'merge_update':
          if (data.status === 'merge_requested') {
            const c = parseInt(document.getElementById('merged-count').textContent) + 1;
            document.getElementById('merged-count').textContent = c;
          }
          break;

        case 'batch_complete':
          document.getElementById('merged-count').textContent = data.merged || 0;
          break;
      }
    }

    function updateWorker(issueNum, status, workerId) {
      if (!workers[issueNum]) {
        workers[issueNum] = {
          status: status,
          worker: workerId,
          title: `Issue #${issueNum}`,
          branch: `agent/issue-${issueNum}`,
          transcript: [],
          pr: null,
        };
      }
      workers[issueNum].status = status;

      // Update counts
      const all = Object.values(workers);
      document.getElementById('workers-total').textContent = all.length;
      document.getElementById('workers-active').textContent =
        all.filter(w => w.status === 'running' || w.status === 'testing').length;

      renderWorkerList();
    }

    function renderWorkerList() {
      const container = document.getElementById('worker-list');
      const sorted = Object.entries(workers).sort((a, b) => a[0] - b[0]);
      container.innerHTML = sorted.map(([num, w]) => `
        <div class="worker-card ${selectedWorker == num ? 'active' : ''}"
             onclick="selectWorker(${num})">
          <div class="worker-header">
            <span class="worker-issue">#${num}</span>
            <span class="worker-status ${w.status}">${w.status}</span>
          </div>
          <div class="worker-title">${w.title}</div>
          <div class="worker-meta">${w.branch} &middot; W${w.worker}</div>
        </div>
      `).join('');
    }

    function selectWorker(issueNum) {
      selectedWorker = issueNum;
      renderWorkerList();
      renderTranscript();
    }

    function renderTranscript() {
      const el = document.getElementById('tab-transcript');
      if (!selectedWorker || !workers[selectedWorker]) {
        el.innerHTML = '<div class="empty-state">Select a worker to view its transcript</div>';
        return;
      }
      const lines = workers[selectedWorker].transcript;
      el.innerHTML = lines.map(l =>
        `<div class="transcript-line">${escapeHtml(l)}</div>`
      ).join('');
      el.scrollTop = el.scrollHeight;
    }

    function appendTranscriptLine(line) {
      if (currentTab !== 'transcript') return;
      const el = document.getElementById('tab-transcript');
      const div = document.createElement('div');
      div.className = 'transcript-line new';
      div.textContent = line;
      el.appendChild(div);
      el.scrollTop = el.scrollHeight;
    }

    function updatePRTable() {
      const tbody = document.getElementById('pr-tbody');
      tbody.innerHTML = prs.map(p => `
        <tr>
          <td><a href="${p.url || '#'}" target="_blank" style="color:var(--accent)">#${p.pr}</a></td>
          <td>#${p.issue}</td>
          <td>${p.branch}</td>
          <td>${p.draft ? 'üìù Draft' : '‚úÖ Ready'}</td>
        </tr>
      `).join('');
    }

    function updateReviewTable() {
      const tbody = document.getElementById('review-tbody');
      tbody.innerHTML = reviews.map(r => {
        const colors = { approve: 'var(--green)', 'request-changes': 'var(--red)', comment: 'var(--yellow)' };
        return `
          <tr>
            <td>#${r.pr}</td>
            <td style="color:${colors[r.verdict] || 'inherit'}">${r.verdict}</td>
            <td>${r.summary || ''}</td>
          </tr>
        `;
      }).join('');
    }

    function addEventLog(type, data, timestamp) {
      const el = document.getElementById('event-log');
      const time = new Date(timestamp).toLocaleTimeString();
      const summary = eventSummary(type, data);
      const div = document.createElement('div');
      div.className = 'event-item';
      div.innerHTML = `<span class="event-time">${time}</span>` +
        `<span class="event-type ${type}">${type.replace('_', ' ')}</span>` +
        `<span>${summary}</span>`;
      el.prepend(div);

      // Also add to timeline tab
      const tl = document.getElementById('timeline-content');
      const tlDiv = div.cloneNode(true);
      tl.prepend(tlDiv);

      // Keep event log manageable
      while (el.children.length > 200) el.lastChild.remove();
    }

    function eventSummary(type, data) {
      switch (type) {
        case 'batch_start': return `Batch ${data.batch} started`;
        case 'phase_change': return data.phase;
        case 'worker_update': return `#${data.issue} ‚Üí ${data.status}`;
        case 'transcript_line': return `#${data.issue || data.pr}`;
        case 'pr_created': return `PR #${data.pr} for #${data.issue}${data.draft ? ' (draft)' : ''}`;
        case 'review_update': return `PR #${data.pr} ‚Üí ${data.verdict || data.status}`;
        case 'merge_update': return `PR #${data.pr} ${data.status}`;
        case 'batch_complete': return `${data.merged} merged, ${data.implemented} implemented`;
        case 'error': return data.message || 'Error';
        default: return JSON.stringify(data).slice(0, 80);
      }
    }

    function switchTab(name) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.main > [id^="tab-"]').forEach(t => t.style.display = 'none');
      event.target.classList.add('active');
      document.getElementById(`tab-${name}`).style.display = '';
      currentTab = name;
      if (name === 'transcript') renderTranscript();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
