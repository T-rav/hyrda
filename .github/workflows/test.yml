name: Test Suite

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest


    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('bot/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        make install-dev

    - name: Run unified linting and type checking
      run: ./scripts/lint.sh

    - name: Run tests with coverage
      env:
        SLACK_BOT_TOKEN: xoxb-test-token-for-ci
        SLACK_APP_TOKEN: xapp-test-token-for-ci
        LLM_PROVIDER: openai
        LLM_API_KEY: test-api-key-for-ci
        LLM_MODEL: gpt-4o-mini
        CACHE_REDIS_URL: redis://localhost:6379/0
        VECTOR_ENABLED: false
        ENVIRONMENT: test
        LOG_LEVEL: WARNING
      run: |
        make test-coverage
