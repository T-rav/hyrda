name: CI Pipeline

on:
  push:
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    name: Complete CI Pipeline

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
        cache-dependency-path: |
          bot/pyproject.toml
          tasks/pyproject.toml
          control_plane/pyproject.toml

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          tasks/ui/package-lock.json
          bot/health_ui/package-lock.json

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Copy .version to service directories
      run: |
        cp .version bot/.version
        cp .version tasks/.version
        cp .version control_plane/.version
        cp .version agent-service/.version
        cp .version rag-service/.version
        cp .version dashboard-service/.version

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e "bot/.[dev,test]"
        pip install -e "tasks/[test]"
        pip install -e "control_plane/[test]"

    - name: "Run quality checks (parallel: linting + tests + UI, no Docker builds)"
      env:
        SLACK_BOT_TOKEN: xoxb-test-token-for-ci
        SLACK_APP_TOKEN: xapp-test-token-for-ci
        LLM_PROVIDER: openai
        LLM_API_KEY: test-api-key-for-ci
        LLM_MODEL: gpt-4o-mini
        CACHE_REDIS_URL: redis://localhost:6379/0
        VECTOR_ENABLED: false
        ENVIRONMENT: test
        LOG_LEVEL: WARNING
        PYTHON: python
        PIP: pip
      run: |
        # Run all quality checks in parallel (skip only ci-docker - Docker image builds belong in deployment pipeline)
        make ci-lint &
        make ci-test-bot &
        make ci-test-control-plane &
        make ci-test-tasks &
        make ci-ui &
        wait
        echo "âœ… All quality checks passed (linting + tests + UI)"
