name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ===== PYTHON SERVICES (Lint + Test) =====
  python-service:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        task: [lint, test]
        service:
          - { name: Bot, dir: bot, markers: "not integration and not system_flow and not smoke", pyright: true, sys-deps: "libffi-dev libssl-dev", cov-fail-under: 70 }
          - { name: Agent Service, dir: agent-service, markers: "not integration and not smoke", cov-fail-under: 70 }
          - { name: Control Plane, dir: control_plane, markers: "not integration and not smoke" }
          - { name: RAG Service, dir: rag-service, markers: "not integration and not smoke" }
          - { name: Dashboard Service, dir: dashboard-service, markers: "not integration and not smoke", cov-fail-under: 70 }
          - { name: Tasks, dir: tasks, markers: "not integration and not smoke", sys-deps-test: ffmpeg, cov-fail-under: 70 }
    name: ${{ matrix.service.name }} ${{ matrix.task }}

    steps:
    - uses: actions/checkout@v4

    - uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true

    - name: Set up Python
      run: uv python install ${{ env.PYTHON_VERSION }}

    - name: Install system dependencies
      if: matrix.service.sys-deps
      run: |
        sudo apt-get update
        sudo apt-get install -y ${{ matrix.service.sys-deps }}

    - name: Install test system dependencies
      if: matrix.task == 'test' && matrix.service.sys-deps-test
      run: |
        sudo apt-get update
        sudo apt-get install -y ${{ matrix.service.sys-deps-test }}

    - name: Install Python dependencies
      working-directory: ${{ matrix.service.dir }}
      run: |
        uv venv
        uv pip install -e ".[dev,test]"

    - name: Run linting
      if: matrix.task == 'lint'
      working-directory: ${{ matrix.service.dir }}
      run: |
        uv run ruff check . --no-fix
        uv run ruff format --check .

    - name: Run type checking
      if: matrix.task == 'lint' && matrix.service.pyright
      working-directory: ${{ matrix.service.dir }}
      run: uv run pyright

    - name: Run tests
      if: matrix.task == 'test'
      working-directory: ${{ matrix.service.dir }}
      env:
        ENVIRONMENT: test
        LOG_LEVEL: WARNING
      run: |
        COV_ARGS="--cov=. --cov-report=term-missing"
        if [ -n "${{ matrix.service.cov-fail-under }}" ]; then
          COV_ARGS="$COV_ARGS --cov-fail-under=${{ matrix.service.cov-fail-under }}"
        fi
        uv run pytest tests/ -v -m "${{ matrix.service.markers }}" $COV_ARGS

  # ===== SHARED TESTS (Migration Integrity) =====
  shared-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    name: Shared Tests

    steps:
    - uses: actions/checkout@v4

    - uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true

    - name: Set up Python
      run: uv python install ${{ env.PYTHON_VERSION }}

    - name: Install test dependencies
      run: |
        uv venv
        uv pip install pytest aiohttp httpx pydantic PyJWT fastapi starlette prometheus-client

    - name: Run shared tests
      env:
        PYTHONPATH: shared
      run: uv run pytest shared/tests/ -v

  # ===== REACT UI =====
  react-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        task: [lint, test, build]
    name: Tasks UI ${{ matrix.task }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: tasks/ui/package-lock.json

    - name: Install dependencies
      working-directory: tasks/ui
      run: npm ci

    - name: Run ESLint
      if: matrix.task == 'lint'
      working-directory: tasks/ui
      run: npm run lint

    - name: Run tests
      if: matrix.task == 'test'
      working-directory: tasks/ui
      run: npm run test:coverage

    - name: Build UI
      if: matrix.task == 'build'
      working-directory: tasks/ui
      run: npm run build

    - name: Upload coverage reports
      if: matrix.task == 'test'
      uses: codecov/codecov-action@v5
      with:
        directory: tasks/ui/coverage
        flags: react-ui
        name: tasks-ui-coverage

  # ===== LIBRECHAT BUILD =====
  librechat-build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    name: LibreChat Build

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Pull LibreChat Docker image
      run: docker compose pull librechat librechat-mongodb

  # ===== DOCKER SECURITY SCAN =====
  docker-security:
    name: Docker Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [python-service]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js for UI build
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: tasks/ui/package-lock.json

    - name: Build Tasks UI
      working-directory: tasks/ui
      run: |
        npm ci
        npm run build

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker images
      run: |
        docker build -f tasks/Dockerfile -t insightmesh-tasks:latest .
        docker build -f bot/Dockerfile -t insightmesh-bot:latest .

    - name: Run Trivy on Tasks Service
      uses: aquasecurity/trivy-action@0.34.0
      with:
        image-ref: 'insightmesh-tasks:latest'
        format: 'sarif'
        output: 'trivy-tasks.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'

    - name: Run Trivy on Bot Service
      uses: aquasecurity/trivy-action@0.34.0
      with:
        image-ref: 'insightmesh-bot:latest'
        format: 'sarif'
        output: 'trivy-bot.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'

    - name: Upload Trivy Tasks results to GitHub Security
      if: always()
      continue-on-error: true
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-tasks.sarif'
        category: 'docker-tasks'

    - name: Upload Trivy Bot results to GitHub Security
      if: always()
      continue-on-error: true
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-bot.sarif'
        category: 'docker-bot'

    - name: Upload Trivy results as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trivy-security-scan-results
        path: trivy-*.sarif

  # ===== EXTENDED SECURITY ANALYSIS =====
  extended-security:
    name: Extended Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [python-service]

    steps:
    - uses: actions/checkout@v4

    - uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true

    - name: Set up Python
      run: uv python install ${{ env.PYTHON_VERSION }}

    - name: Install security tools and service dependencies
      run: |
        uv venv
        uv pip install "bandit[toml]" pip-audit checkov semgrep
        for service in bot agent-service control_plane tasks rag-service dashboard-service; do
          if [ -f "$service/pyproject.toml" ]; then
            uv pip install -e "$service/" 2>/dev/null || true
          fi
        done

    - name: Run Bandit on all services
      run: |
        for service in bot agent-service control_plane tasks rag-service dashboard-service; do
          echo "--- $service ---"
          uv run bandit -r "$service/" -f json \
            --exclude "./$service/tests,./$service/.venv,./$service/venv,./$service/node_modules" \
            -o "bandit-${service}.json"
        done
      continue-on-error: true

    - name: Run pip-audit (dependency vulnerabilities)
      run: uv run pip-audit
      continue-on-error: true

    - name: Run Checkov (infrastructure security)
      run: uv run checkov --file docker-compose.yml --quiet --compact
      continue-on-error: true

    - name: Run Semgrep on all services
      run: |
        uv run semgrep --config=auto --error \
          bot/ agent-service/ control_plane/ tasks/ rag-service/ dashboard-service/
      continue-on-error: true

    - name: Upload security scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: extended-security-scan-results
        path: bandit-*.json
