name: Test Suite

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        task: [lint, test]
    name: ${{ matrix.task }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: cache-venv
      with:
        path: venv
        key: ${{ runner.os }}-venv-${{ hashFiles('bot/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-venv-

    - name: Install dependencies
      if: steps.cache-venv.outputs.cache-hit != 'true'
      run: |
        python -m pip install --upgrade pip
        make install-dev

    - name: Run unified linting and type checking
      if: matrix.task == 'lint'
      run: make lint-check

    - name: Run tests with coverage
      if: matrix.task == 'test'
      env:
        SLACK_BOT_TOKEN: xoxb-test-token-for-ci
        SLACK_APP_TOKEN: xapp-test-token-for-ci
        LLM_PROVIDER: openai
        LLM_API_KEY: test-api-key-for-ci
        LLM_MODEL: gpt-4o-mini
        CACHE_REDIS_URL: redis://localhost:6379/0
        VECTOR_ENABLED: false
        ENVIRONMENT: test
        LOG_LEVEL: WARNING
      run: make test-coverage
