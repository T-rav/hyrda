name: insightmesh

services:
  # MySQL Database
  mysql:
    image: public.ecr.aws/docker/library/mysql:8.0
    container_name: insightmesh-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-changeme_root_password}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -p$${MYSQL_ROOT_PASSWORD} || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        tag: "{{.Name}}"
        labels: "service,component"
    labels:
      logging: "promtail"
      service: "mysql"
      component: "database"
    networks:
      - insightmesh

  # phpMyAdmin for database management
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: insightmesh-phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${MYSQL_ROOT_PASSWORD:-changeme_root_password}
    ports:
      - "8081:80"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - insightmesh

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: insightmesh-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"  # REST API + Dashboard
      - "6334:6334"  # gRPC API
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__API_KEY=${VECTOR_API_KEY:-}  # Set in .env for security
    healthcheck:
      test: ["CMD-SHELL", "timeout 3s bash -c ':> /dev/tcp/127.0.0.1/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        tag: "{{.Name}}"
        labels: "service,component"
    labels:
      logging: "promtail"
      service: "qdrant"
      component: "vector-database"
    networks:
      - insightmesh

  # Task Scheduler Service (nginx + Flask in single container)
  tasks:
    build:
      context: .
      dockerfile: tasks/Dockerfile
    image: insightmesh-tasks:latest
    container_name: insightmesh-tasks
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - TASK_DATABASE_URL=mysql+pymysql://insightmesh_tasks:${MYSQL_TASKS_PASSWORD:-changeme_tasks_password}@mysql:3306/insightmesh_task
      - DATA_DATABASE_URL=mysql+pymysql://insightmesh_data:${MYSQL_DATA_PASSWORD:-changeme_data_password}@mysql:3306/insightmesh_data
      - SECURITY_DATABASE_URL=mysql+pymysql://insightmesh_security:${MYSQL_SECURITY_PASSWORD:-changeme_security_password}@mysql:3306/insightmesh_security
      - SYSTEM_DATABASE_URL=mysql+pymysql://insightmesh_system:${MYSQL_SYSTEM_PASSWORD:-changeme_system_password}@mysql:3306/insightmesh_system
      - SLACK_BOT_API_URL=http://bot:8080
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_API_KEY=${VECTOR_API_KEY:-}
      - VECTOR_HOST=qdrant
      - VECTOR_PORT=6333
      - VECTOR_API_KEY=${VECTOR_API_KEY:-}
      - ENVIRONMENT=production
      - FLASK_PORT=8081
      - LANGFUSE_ENABLED=${LANGFUSE_ENABLED:-false}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-}
      - LANGFUSE_DEBUG=${LANGFUSE_DEBUG:-false}
      - LANGSMITH_API_KEY=${LANGSMITH_API_KEY:-}
      - GOOGLE_OAUTH_CLIENT_ID=${GOOGLE_OAUTH_CLIENT_ID:-}
      - GOOGLE_OAUTH_CLIENT_SECRET=${GOOGLE_OAUTH_CLIENT_SECRET:-}
      - ALLOWED_EMAIL_DOMAIN=${ALLOWED_EMAIL_DOMAIN:-@8thlight.com}
      - SERVER_BASE_URL=${SERVER_BASE_URL:-http://localhost:5001}
    ports:
      - "${TASKS_PORT:-5001}:5001"
    depends_on:
      mysql:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    command: >
      sh -c "
        echo '=== Creating databases ===' &&
        mysql -h mysql -u root -p$${MYSQL_ROOT_PASSWORD} --skip-ssl -e 'CREATE DATABASE IF NOT EXISTS insightmesh_task CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;' &&
        mysql -h mysql -u root -p$${MYSQL_ROOT_PASSWORD} --skip-ssl -e 'CREATE DATABASE IF NOT EXISTS insightmesh_data CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;' &&
        mysql -h mysql -u root -p$${MYSQL_ROOT_PASSWORD} --skip-ssl -e 'CREATE DATABASE IF NOT EXISTS insightmesh_security CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;' &&
        echo '=== Creating database users ===' &&
        mysql -h mysql -u root -p$${MYSQL_ROOT_PASSWORD} --skip-ssl -e \"CREATE USER IF NOT EXISTS 'insightmesh_tasks'@'%' IDENTIFIED BY '$${MYSQL_TASKS_PASSWORD}';\" &&
        mysql -h mysql -u root -p$${MYSQL_ROOT_PASSWORD} --skip-ssl -e \"GRANT ALL PRIVILEGES ON insightmesh_task.* TO 'insightmesh_tasks'@'%';\" &&
        mysql -h mysql -u root -p$${MYSQL_ROOT_PASSWORD} --skip-ssl -e \"CREATE USER IF NOT EXISTS 'insightmesh_data'@'%' IDENTIFIED BY '$${MYSQL_DATA_PASSWORD}';\" &&
        mysql -h mysql -u root -p$${MYSQL_ROOT_PASSWORD} --skip-ssl -e \"GRANT ALL PRIVILEGES ON insightmesh_data.* TO 'insightmesh_data'@'%';\" &&
        mysql -h mysql -u root -p$${MYSQL_ROOT_PASSWORD} --skip-ssl -e \"CREATE USER IF NOT EXISTS 'insightmesh_security'@'%' IDENTIFIED BY '$${MYSQL_SECURITY_PASSWORD}';\" &&
        mysql -h mysql -u root -p$${MYSQL_ROOT_PASSWORD} --skip-ssl -e \"GRANT ALL PRIVILEGES ON insightmesh_security.* TO 'insightmesh_security'@'%';\" &&
        mysql -h mysql -u root -p$${MYSQL_ROOT_PASSWORD} --skip-ssl -e 'FLUSH PRIVILEGES;' &&
        echo '=== Running task database migrations ===' &&
        alembic upgrade head &&
        echo '=== Running data database migrations ===' &&
        alembic -c alembic_data.ini upgrade head &&
        echo '=== Starting services ===' &&
        /usr/bin/supervisord
      "
    logging:
      driver: "json-file"
      options:
        tag: "{{.Name}}"
        labels: "service,component"
    labels:
      logging: "promtail"
      service: "tasks"
      component: "scheduler"
    networks:
      - insightmesh

  # Redis Cache Service
  redis:
    image: public.ecr.aws/docker/library/redis:7-alpine
    container_name: insightmesh-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - insightmesh

  # System Dashboard Service
  dashboard:
    build:
      context: ./dashboard-service
      dockerfile: Dockerfile
    image: insightmesh-dashboard:latest
    container_name: insightmesh-dashboard
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - GOOGLE_OAUTH_CLIENT_ID=${GOOGLE_OAUTH_CLIENT_ID:-}
      - GOOGLE_OAUTH_CLIENT_SECRET=${GOOGLE_OAUTH_CLIENT_SECRET:-}
      - ALLOWED_EMAIL_DOMAIN=${ALLOWED_EMAIL_DOMAIN:-@8thlight.com}
      - DASHBOARD_BASE_URL=${DASHBOARD_BASE_URL:-http://localhost:8080}
      - ENVIRONMENT=${ENVIRONMENT:-production}
    ports:
      - "8080:8080"
    depends_on:
      bot:
        condition: service_started
      agent_service:
        condition: service_started
      tasks:
        condition: service_started
      control_plane:
        condition: service_started
    logging:
      driver: "json-file"
      options:
        tag: "{{.Name}}"
        labels: "service,component"
    labels:
      logging: "promtail"
      service: "dashboard"
      component: "monitoring"
    networks:
      - insightmesh

  # AI Slack Bot Service
  bot:
    build:
      context: .
      dockerfile: ./bot/Dockerfile
    image: insightmesh-bot:latest
    container_name: insightmesh-bot
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - DATABASE_URL=mysql+pymysql://root:${MYSQL_ROOT_PASSWORD:-changeme_root_password}@mysql:3306/insightmesh_data
      - SECURITY_DATABASE_URL=mysql+pymysql://insightmesh_security:${MYSQL_SECURITY_PASSWORD:-changeme_security_password}@mysql:3306/insightmesh_security
      - VECTOR_HOST=qdrant
      - VECTOR_PORT=6333
      - VECTOR_API_KEY=${VECTOR_API_KEY:-}
      - CACHE_REDIS_URL=redis://redis:6379
      - ENVIRONMENT=production
      - AGENT_SERVICE_URL=http://agent_service:8000
      - BOT_SERVICE_TOKEN=${BOT_SERVICE_TOKEN}
      - CONTROL_PLANE_SERVICE_TOKEN=${CONTROL_PLANE_SERVICE_TOKEN}
      - ENABLE_HEALTH_SERVER=true  # Internal metrics only, no external port
    # No external ports - dashboard service aggregates metrics
    depends_on:
      mysql:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy
      agent_service:
        condition: service_started
    command: >
      sh -c "
        python -u app.py
      "
    logging:
      driver: "json-file"
      options:
        tag: "{{.Name}}"
        labels: "service,component"
    labels:
      logging: "promtail"
      service: "bot"
      component: "slack-bot"
    networks:
      - insightmesh

  # Control Plane Service
  control_plane:
    build:
      context: .
      dockerfile: control_plane/Dockerfile
    image: insightmesh-control-plane:latest
    container_name: insightmesh-control-plane
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - SECURITY_DATABASE_URL=mysql+pymysql://insightmesh_security:${MYSQL_SECURITY_PASSWORD:-changeme_security_password}@mysql:3306/insightmesh_security
      - DATA_DATABASE_URL=mysql+pymysql://insightmesh_data:${MYSQL_DATA_PASSWORD:-changeme_data_password}@mysql:3306/insightmesh_data
      - SYSTEM_DATABASE_URL=mysql+pymysql://insightmesh_system:${MYSQL_SYSTEM_PASSWORD:-changeme_system_password}@mysql:3306/insightmesh_system
      - SECRET_KEY=${SECRET_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - CACHE_REDIS_URL=redis://redis:6379
      - BOT_SERVICE_TOKEN=${BOT_SERVICE_TOKEN}
      - CONTROL_PLANE_SERVICE_TOKEN=${CONTROL_PLANE_SERVICE_TOKEN}
      - FLASK_ENV=production
      - ALLOWED_EMAIL_DOMAIN=${ALLOWED_EMAIL_DOMAIN:-@8thlight.com}
      - GOOGLE_OAUTH_CLIENT_ID=${GOOGLE_OAUTH_CLIENT_ID:-}
      - GOOGLE_OAUTH_CLIENT_SECRET=${GOOGLE_OAUTH_CLIENT_SECRET:-}
      - CONTROL_PLANE_BASE_URL=${CONTROL_PLANE_BASE_URL:-http://localhost:6001}
    ports:
      - "${CONTROL_PLANE_PORT:-6001}:6001"
    depends_on:
      mysql:
        condition: service_healthy
    command: >
      sh -c "
        echo '=== Running security database migrations ===' &&
        alembic upgrade head &&
        echo '=== Starting Uvicorn ===' &&
        exec uvicorn app:app --host 0.0.0.0 --port 6001 --workers 4
      "
    logging:
      driver: "json-file"
      options:
        tag: "{{.Name}}"
        labels: "service,component"
    labels:
      logging: "promtail"
      service: "control_plane"
      component: "admin-ui"
    networks:
      - insightmesh

  # Agent Service - LangGraph agent execution
  agent_service:
    build:
      context: .
      dockerfile: ./agent-service/Dockerfile
    image: insightmesh-agent-service:latest
    container_name: insightmesh-agent-service
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - DATA_DATABASE_URL=mysql+pymysql://insightmesh_data:${MYSQL_DATA_PASSWORD:-changeme_data_password}@mysql:3306/insightmesh_data
      - SECURITY_DATABASE_URL=mysql+pymysql://insightmesh_security:${MYSQL_SECURITY_PASSWORD:-changeme_security_password}@mysql:3306/insightmesh_security
      - SYSTEM_DATABASE_URL=mysql+pymysql://insightmesh_system:${MYSQL_SYSTEM_PASSWORD:-changeme_system_password}@mysql:3306/insightmesh_system
      - VECTOR_HOST=qdrant
      - VECTOR_PORT=6333
      - VECTOR_API_KEY=${VECTOR_API_KEY:-}
      - CACHE_REDIS_URL=redis://redis:6379
      - ENVIRONMENT=production
      - PORT=8000
      - BOT_SERVICE_TOKEN=${BOT_SERVICE_TOKEN}
      - CONTROL_PLANE_SERVICE_TOKEN=${CONTROL_PLANE_SERVICE_TOKEN}
      - CONTROL_PLANE_URL=http://control_plane:6001
      - LANGFUSE_ENABLED=${LANGFUSE_ENABLED:-false}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-}
      - LANGFUSE_DEBUG=${LANGFUSE_DEBUG:-false}
      - LANGSMITH_API_KEY=${LANGSMITH_API_KEY:-}
    ports:
      - "${AGENT_SERVICE_PORT:-8000}:8000"
    depends_on:
      mysql:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        tag: "{{.Name}}"
        labels: "service,component"
    labels:
      logging: "promtail"
      service: "agent_service"
      component: "agents"
    networks:
      - insightmesh

  # Loki - Log Aggregation Server
  loki:
    image: grafana/loki:latest
    container_name: insightmesh-loki
    restart: unless-stopped
    user: "0"  # Run as root to avoid permission issues with /loki volume
    ports:
      - "3100:3100"
    volumes:
      - ./monitoring/loki.yml:/etc/loki/local-config.yaml
      - loki_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - insightmesh

  # Promtail - Log Shipper
  promtail:
    image: grafana/promtail:latest
    container_name: insightmesh-promtail
    restart: unless-stopped
    volumes:
      - ./monitoring/promtail.yml:/etc/promtail/config.yml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    networks:
      - insightmesh

volumes:
  mysql_data:
    driver: local
  qdrant_data:
    driver: local
  redis_data:
    driver: local
  loki_data:
    driver: local

networks:
  insightmesh:
    name: insightmesh
    driver: bridge
