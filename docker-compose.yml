name: insightmesh

services:
  # MySQL Database
  mysql:
    image: public.ecr.aws/docker/library/mysql:8.0
    container_name: insightmesh-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    networks:
      - insightmesh

  # phpMyAdmin for database management
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: insightmesh-phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: password
    ports:
      - "8081:80"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - insightmesh

  # Elasticsearch for vector search
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: insightmesh-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - cluster.name=insightmesh-knowledge-base
      - node.name=insightmesh-node
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - insightmesh

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: insightmesh-qdrant
    restart: unless-stopped
    ports:
      - "127.0.0.1:6333:6333"  # REST API - bound to localhost only
      - "127.0.0.1:6334:6334"  # gRPC API - bound to localhost only
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6333/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - insightmesh

  # Task Scheduler Service (nginx + Flask in single container)
  tasks:
    build:
      context: ./tasks
      dockerfile: Dockerfile
    image: insightmesh-tasks:latest
    container_name: insightmesh-tasks
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - TASK_DATABASE_URL=mysql+pymysql://insightmesh_tasks:insightmesh_tasks_password@mysql:3306/insightmesh_task
      - DATA_DATABASE_URL=mysql+pymysql://insightmesh_data:insightmesh_data_password@mysql:3306/insightmesh_data
      - SLACK_BOT_API_URL=http://bot:8080
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - ENVIRONMENT=production
      - FLASK_PORT=8081
    ports:
      - "${TASKS_PORT:-5001}:5001"
    depends_on:
      mysql:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    command: >
      sh -c "
        echo '=== Creating databases ===' &&
        mysql -h mysql -u root -ppassword --skip-ssl -e 'CREATE DATABASE IF NOT EXISTS insightmesh_task CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;' &&
        mysql -h mysql -u root -ppassword --skip-ssl -e 'CREATE DATABASE IF NOT EXISTS insightmesh_data CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;' &&
        echo '=== Creating database users ===' &&
        mysql -h mysql -u root -ppassword --skip-ssl -e \"CREATE USER IF NOT EXISTS 'insightmesh_tasks'@'%' IDENTIFIED BY 'insightmesh_tasks_password';\" &&
        mysql -h mysql -u root -ppassword --skip-ssl -e \"GRANT ALL PRIVILEGES ON insightmesh_task.* TO 'insightmesh_tasks'@'%';\" &&
        mysql -h mysql -u root -ppassword --skip-ssl -e \"CREATE USER IF NOT EXISTS 'insightmesh_data'@'%' IDENTIFIED BY 'insightmesh_data_password';\" &&
        mysql -h mysql -u root -ppassword --skip-ssl -e \"GRANT ALL PRIVILEGES ON insightmesh_data.* TO 'insightmesh_data'@'%';\" &&
        mysql -h mysql -u root -ppassword --skip-ssl -e 'FLUSH PRIVILEGES;' &&
        echo '=== Running task database migrations ===' &&
        alembic upgrade head &&
        echo '=== Running data database migrations ===' &&
        alembic -c alembic_data.ini upgrade head &&
        echo '=== Starting services ===' &&
        /usr/bin/supervisord
      "
    networks:
      - insightmesh

  # Redis Cache Service
  redis:
    image: public.ecr.aws/docker/library/redis:7-alpine
    container_name: insightmesh-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - insightmesh

  # AI Slack Bot Service
  bot:
    build:
      context: ./bot
      dockerfile: Dockerfile
    image: insightmesh-bot:latest
    container_name: insightmesh-bot
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - DATABASE_URL=mysql+pymysql://root:password@mysql:3306/insightmesh_data
      - VECTOR_HOST=qdrant
      - VECTOR_PORT=6333
      - CACHE_REDIS_URL=redis://redis:6379
      - ENVIRONMENT=production
    ports:
      - "${HEALTH_PORT:-8080}:8080"
    depends_on:
      mysql:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: >
      sh -c "
        python -u app.py
      "
    networks:
      - insightmesh

volumes:
  mysql_data:
    driver: local
  elasticsearch_data:
    driver: local
  qdrant_data:
    driver: local
  redis_data:
    driver: local

networks:
  insightmesh:
    name: insightmesh
    driver: bridge
